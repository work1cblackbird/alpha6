#Область СлужебныеПроцедурыИФункции

Функция PutCallInfo(LineName, CallerID, CallInfo)
	
	ЧтениеJSON = Новый ЧтениеJSON();
	ЧтениеJSON.УстановитьСтроку(CallInfo);
	json = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	Если json.Свойство("comagic_context") И ЗначениеЗаполнено(CallerID) Тогда
		НомерТелефона = Прав(json.ani, 10);
		
		УстановитьПривилегированныйРежим(Истина);
		
		МенеджерЗаписи = РегистрыСведений.сфпДанныеКоллтрекинга.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.НомерТелефона = НомерТелефона;
		МенеджерЗаписи.ДатаЗвонка = ТекущаяДата();
		МенеджерЗаписи.Идентификатор = json.comagic_context.visitor_id;
		МенеджерЗаписи.Сайт = json.comagic_context.site;
		МенеджерЗаписи.utm_campaign = json.comagic_context.campaign;
		МенеджерЗаписи.utm_term = json.comagic_context.search_query;
		МенеджерЗаписи.Записать();
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ НомерТелефона
		|ИЗ РегистрСведений.сфпДанныеКоллтрекинга
		|ГДЕ ДатаЗвонка < &ДатаПроверки");
		Запрос.УстановитьПараметр("ДатаПроверки", (ТекущаяДата() - 3600));
		
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			МенеджерЗаписи = РегистрыСведений.сфпДанныеКоллтрекинга.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.НомерТелефона = Выборка.НомерТелефона;
			МенеджерЗаписи.Прочитать();
			Если МенеджерЗаписи.Выбран() Тогда
				МенеджерЗаписи.Удалить();
			КонецЕсли;
		КонецЦикла;	
		
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;
	
	Возврат "OK";

КонецФункции

#КонецОбласти