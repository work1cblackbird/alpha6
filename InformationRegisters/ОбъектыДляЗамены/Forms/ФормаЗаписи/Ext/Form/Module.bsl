///////////////////////////////////////////////////////////////////////////////
// Модуль формы записи регистра "Сведения о сотрудниках"
//
///////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Отказ = Отказ Или РаботаСФормой.НужноОтменитьОткрытиеФормы();
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Запись.ИдентификаторЗаменяемого) Тогда
		ЧтоЗаменить = ОбщегоНазначения.ЗначениеИзСтрокиXML(Запись.ИдентификаторЗаменяемого);
	КонецЕсли;
	Если ЗначениеЗаполнено(Запись.ИдентификаторЗаменителя) Тогда
		НаЧтоЗаменить = ОбщегоНазначения.ЗначениеИзСтрокиXML(Запись.ИдентификаторЗаменителя);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Запись.Автор) Тогда
		Запись.Автор = Пользователи.ТекущийПользователь();
	КонецЕсли;

	Если Запись.ИсходныйКлючЗаписи.Пустой() Тогда
		НастроитьПараметрыВыбораЭлементовФормы();
		УправлениеДиалогомНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)

	НастроитьПараметрыВыбораЭлементовФормы();
	УправлениеДиалогомНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	ТекущийОбъект.Автор = Пользователи.ТекущийПользователь();

	ТекущийОбъект.ПредставлениеЗаменяемого = Строка(ЧтоЗаменить); 
	ТекущийОбъект.ПредставлениеЗаменителя  = Строка(НаЧтоЗаменить);
	
	ТекущийОбъект.ИдентификаторЗаменяемого 	= ОбщегоНазначения.ЗначениеВСтрокуXML(ЧтоЗаменить);
	ТекущийОбъект.ИдентификаторЗаменителя   = ОбщегоНазначения.ЗначениеВСтрокуXML(НаЧтоЗаменить);

КонецПроцедуры 

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ЧтоЗаменитьПриИзменении(Элемент)
	
	ТипЧтоЗаменить();
	
КонецПроцедуры

&НаКлиенте
Процедура НаЧтоЗаменитьНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(ЧтоЗаменить) И ТипЗнч(НаЧтоЗаменить) <> Тип("Неопределено") И ТипЗнч(ЧтоЗаменить) = ТипЗнч(НаЧтоЗаменить) Тогда
		СтандартнаяОбработка = Ложь;
		ПолноеИмя = ПолучитьПолноеИмя(ЧтоЗаменить);
		// Формируем описание обработчика перехвата закрытия формы
		ОбработчикРезультата = Новый ОписаниеОповещения("ОбработкаРезультатаОповещенияНаЧтоЗаменить", ЭтотОбъект);
		ОткрытьФорму(ПолноеИмя+".ФормаВыбора", Новый Структура("РежимВыбора", Истина),,,,,ОбработчикРезультата);
	ИначеЕсли Не ЗначениеЗаполнено(ЧтоЗаменить) Тогда
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НаЧтоЗаменитьОчистка(Элемент, СтандартнаяОбработка)
	
	ТипНаЧтоЗаменить();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ТипЧтоЗаменить()
	
	МассивТипов = Новый Массив(1);
	МассивТипов.Добавить(ТипЗнч(ЧтоЗаменить));
	ОписаниеТипов = Новый ОписаниеТипов(МассивТипов);
	НаЧтоЗаменить = ОписаниеТипов.ПривестиЗначение(НаЧтоЗаменить);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьПолноеИмя(Элемент)
	
	Возврат Элемент.Метаданные().ПолноеИмя();
	
КонецФункции

&НаСервере
Процедура ТипНаЧтоЗаменить()
	
	МассивТипов = Новый Массив(1);
	МассивТипов.Добавить(ТипЗнч(ЧтоЗаменить));
	ОписаниеТипов = Новый ОписаниеТипов(МассивТипов);
	НаЧтоЗаменить = ОписаниеТипов.ПривестиЗначение(НаЧтоЗаменить);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаРезультатаОповещенияНаЧтоЗаменить(РезультатОповещения, ДополнительныеПараметры=Неопределено) Экспорт
	
	Если РезультатОповещения=Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НаЧтоЗаменить = РезультатОповещения;
	
КонецПроцедуры 

#Область ОбработчикиСлужебногоПрограммногоИнтерфейса

&НаСервере
Процедура НастроитьПараметрыВыбораЭлементовФормы()
	
	УправлениеДиалогомРегистраСервер.НастроитьПараметрыВыбораЭлементовФормы(ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура УправлениеДиалогомНаСервере()
	
	УправлениеДиалогомРегистраСервер.УправлениеДиалогомНаСервере(ЭтотОбъект);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

