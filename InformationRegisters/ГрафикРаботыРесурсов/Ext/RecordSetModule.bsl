
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОписаниеПеременных

Перем НаборЗаписей Экспорт;		// Записан для формирования записей
Перем ДокументОбъект Экспорт;	// Документ объект для записи

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Получает различные значения измерений набора записей регистра в виде
// таблицы значений для регистрации изменений.
//
Функция ПолучитьПоНаборуЗаписейРазличныеЗначенияИзмерений(ЭтотОбъект) Экспорт
	
	ТипЗначенияОбъекта = ТипЗнч(ЭтотОбъект);
	МетаданныеРегистра = Метаданные.НайтиПоТипу(ТипЗначенияОбъекта);

	Измерения = МетаданныеРегистра.Измерения;
	СтрокаИзмерения = "";
	
	Для Каждого ЗначениеИзмерения Из Измерения Цикл
		
		Если НЕ ЗначениеИзмерения.ОсновнойОтбор Тогда
			
			Продолжить;
			
		КонецЕсли; 
		
		СтрокаИзмерения = СтрокаИзмерения + "," + ЗначениеИзмерения.Имя;
		
	КонецЦикла;
	
	СтрокаИзмерения = Сред(СтрокаИзмерения, 2);
	ЗначенияИзмерений = ЭтотОбъект.Выгрузить();
	ЗначенияИзмерений.Свернуть(СтрокаИзмерения);
	
	Возврат ЗначенияИзмерений;
	
КонецФункции

// Формирует движения по регистру
// Возвращаемое значение: Булево. Истина - все хорошо, Ложь - чего-то не так.
Функция Проведение() Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	НаборЗаписейГрафикРаботыРесурсов = РегистрыСведений.ГрафикРаботыРесурсов.СоздатьНаборЗаписей();
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.Значение      = ДокументОбъект.Ссылка;
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.ВидСравнения  = ВидСравнения.Равно;
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.Использование = Истина;
	НаборЗаписейГрафикРаботыРесурсов.Прочитать();
	
	Для Каждого СтрокаНабораЗаписей Из НаборЗаписей Цикл
		СтрокаГрафикаРаботыРесурсов = НаборЗаписейГрафикРаботыРесурсов.Добавить();
		// Заполним свойства "Ресурс1,Ресурс2,Объект,Дата,НачалоРабочегоВремени,КонецРабочегоВремени,Продолжительность,КоличествоНатуральныхЕдиниц,НапомнитьЗа,Авторабота,ХозОперация,Авторабота".
		ЗаполнитьЗначенияСвойств(СтрокаГрафикаРаботыРесурсов, СтрокаНабораЗаписей);
		
		Если НЕ ЗначениеЗаполнено(СтрокаГрафикаРаботыРесурсов.ХозОперация) Тогда
			
			СтрокаГрафикаРаботыРесурсов.ХозОперация = ДокументОбъект.ХозОперация;
			
		КонецЕсли;
		
	КонецЦикла;
	
	НаборЗаписейГрафикРаботыРесурсов.Записать();
	
	Возврат Ложь;
	
КонецФункции

// Удаляет движения по регистру
// Возвращаемое значение: Булево. Истина - все хорошо, Ложь - чего-то не так.
Функция ОтменаПроведения() Экспорт
	
	ЕстьОшибки = Ложь;
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Очистим регистр ГрафикРаботыРесурсов
	НаборЗаписейГрафикРаботыРесурсов = РегистрыСведений.ГрафикРаботыРесурсов.СоздатьНаборЗаписей();
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.Значение = ДокументОбъект.Ссылка;
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.ВидСравнения = ВидСравнения.Равно;
	НаборЗаписейГрафикРаботыРесурсов.Отбор.Объект.Использование = Истина;
	НаборЗаписейГрафикРаботыРесурсов.Прочитать();
	
	// получим значения измерений старого набора записей
	СтарыйНаборЗначенияИзмерений = ПолучитьПоНаборуЗаписейРазличныеЗначенияИзмерений(НаборЗаписейГрафикРаботыРесурсов);
	НаборЗаписейГрафикРаботыРесурсов.ДополнительныеСвойства.Вставить("ЗначенияИзмерений", СтарыйНаборЗначенияИзмерений);

	НаборЗаписейГрафикРаботыРесурсов.Очистить();
	НаборЗаписейГрафикРаботыРесурсов.Записать();
	
	Возврат ЕстьОшибки;
	
КонецФункции

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)

	Если НЕ ОбработкаСобытийРегистраСервер.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты) Тогда
		
		Возврат;
		
	КонецЕсли;
	
КонецПроцедуры 

Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		
		Возврат;
		
	КонецЕсли;

	// Регистрация изменений
	ЗначенияИзмерений = Неопределено;
	ЭтотОбъект.ДополнительныеСвойства.Свойство("ЗначенияИзмерений", ЗначенияИзмерений);
	
	Если ЗначенияИзмерений = Неопределено Тогда
		// получим значения измерений текущего набора записей
		ЗначенияИзмерений = ПолучитьПоНаборуЗаписейРазличныеЗначенияИзмерений(ЭтотОбъект);
	КонецЕсли;
	
	КонецПроцедуры 
#КонецОбласти

#КонецЕсли