
#Область ОбработчикиСобытий

#Область Обработчики

Функция ИдентификаторОбъектаВыгрузки(ОбъектСсылка, ИмяФорматаОбъекта, МестоРазмещения = Неопределено, НомерСтрокиВыписки = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ИдентификаторыВыгружаемыхОбъектов.ИдентификаторОбъекта КАК ИдентификаторОбъекта
	|ИЗ
	|	РегистрСведений.ИдентификаторыВыгружаемыхОбъектов КАК ИдентификаторыВыгружаемыхОбъектов
	|ГДЕ
	|	ИдентификаторыВыгружаемыхОбъектов.Объект = &Объект
	|	И ИдентификаторыВыгружаемыхОбъектов.ИмяФорматаОбъекта = &ИмяФорматаОбъекта
	|	И ИдентификаторыВыгружаемыхОбъектов.НомерСтрокиВыписки = &НомерСтрокиВыписки
	|	И ИдентификаторыВыгружаемыхОбъектов.МестоРазмещения = &МестоРазмещения";
	Запрос.УстановитьПараметр("Объект", ОбъектСсылка);
	Запрос.УстановитьПараметр("ИмяФорматаОбъекта", ИмяФорматаОбъекта);
	Запрос.УстановитьПараметр("МестоРазмещения", МестоРазмещения);
	Запрос.УстановитьПараметр("НомерСтрокиВыписки", НомерСтрокиВыписки);
	
	Выборка = Запрос.Выполнить().Выбрать();
	ЭтоВыписка = ?(НомерСтрокиВыписки <> Неопределено, Истина, Ложь);
	
	Если Выборка.Следующий() Тогда
		УникальныйИдентификаторОбъекта = Новый УникальныйИдентификатор(Выборка.ИдентификаторОбъекта);
	Иначе
		УникальныйИдентификаторОбъекта = Новый УникальныйИдентификатор();
		
		НаборЗаписей = РегистрыСведений.ИдентификаторыВыгружаемыхОбъектов.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(ОбъектСсылка);
		НаборЗаписей.Отбор.ИмяФорматаОбъекта.Установить(ИмяФорматаОбъекта);
		Если ЭтоВыписка Тогда
			НаборЗаписей.Отбор.НомерСтрокиВыписки.Установить(НомерСтрокиВыписки);
		Иначе
			НаборЗаписей.Отбор.МестоРазмещения.Установить(МестоРазмещения);
		КонецЕсли;
		
		Запись = НаборЗаписей.Добавить();
		Запись.Объект               = ОбъектСсылка;
		Запись.ИмяФорматаОбъекта    = ИмяФорматаОбъекта;
		Если ЭтоВыписка Тогда
			Запись.НомерСтрокиВыписки  = НомерСтрокиВыписки;
		Иначе
			Запись.МестоРазмещения      = МестоРазмещения;
		КонецЕсли;
		Запись.ИдентификаторОбъекта = Строка(УникальныйИдентификаторОбъекта);
		
		НаборЗаписей.Записать(Истина);
		
	КонецЕсли;
	
	Возврат УникальныйИдентификаторОбъекта;
	
КонецФункции

Функция ИдентификаторыОбъекта(ОбъектСсылка) Экспорт 
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ИдентификаторыВыгружаемыхОбъектов.ИдентификаторОбъекта КАК ИдентификаторОбъекта
	               |ИЗ
	               |	РегистрСведений.ИдентификаторыВыгружаемыхОбъектов КАК ИдентификаторыВыгружаемыхОбъектов
	               |ГДЕ
	               |	ИдентификаторыВыгружаемыхОбъектов.Объект = &Объект";
	Запрос.УстановитьПараметр("Объект", ОбъектСсылка);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ИдентификаторОбъекта");
	
КонецФункции

Процедура ОбработкаСтрокиВыписки(ОбъектСсылка, ИмяФорматаОбъекта, НомерСтрокиВыписки, ИдентификаторОбъекта) Экспорт
		
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ИдентификаторыВыгружаемыхОбъектов.ИдентификаторОбъекта КАК ИдентификаторОбъекта
	|ИЗ
	|	РегистрСведений.ИдентификаторыВыгружаемыхОбъектов КАК ИдентификаторыВыгружаемыхОбъектов
	|ГДЕ
	|	ИдентификаторыВыгружаемыхОбъектов.Объект = &Объект
	|	И ИдентификаторыВыгружаемыхОбъектов.ИмяФорматаОбъекта = &ИмяФорматаОбъекта
	|	И ИдентификаторыВыгружаемыхОбъектов.НомерСтрокиВыписки = &НомерСтрокиВыписки";
	Запрос.УстановитьПараметр("Объект", ОбъектСсылка);
	Запрос.УстановитьПараметр("ИмяФорматаОбъекта", ИмяФорматаОбъекта);
	Запрос.УстановитьПараметр("НомерСтрокиВыписки", НомерСтрокиВыписки);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Если НЕ Выборка.Следующий() Тогда
		
		НаборЗаписей = РегистрыСведений.ИдентификаторыВыгружаемыхОбъектов.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(ОбъектСсылка);
		НаборЗаписей.Отбор.ИмяФорматаОбъекта.Установить(ИмяФорматаОбъекта);
		НаборЗаписей.Отбор.НомерСтрокиВыписки.Установить(НомерСтрокиВыписки);
		
		Запись = НаборЗаписей.Добавить();
		Запись.Объект               = ОбъектСсылка;
		Запись.ИмяФорматаОбъекта    = ИмяФорматаОбъекта;
		Запись.НомерСтрокиВыписки  = НомерСтрокиВыписки;
		Запись.ИдентификаторОбъекта = Строка(ИдентификаторОбъекта);
		
		НаборЗаписей.Записать(Истина);
		
	КонецЕсли;
	
КонецПроцедуры   

Процедура УдалитьЗаписи(ОбъектСсылка, ИмяФорматаОбъекта, НомерСтрокиВыписки) Экспорт
		
		НаборЗаписей = РегистрыСведений.ИдентификаторыВыгружаемыхОбъектов.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(ОбъектСсылка); 
		НаборЗаписей.Отбор.НомерСтрокиВыписки.Установить(ИмяФорматаОбъекта); 
		НаборЗаписей.Отбор.ИмяФорматаОбъекта.Установить(НомерСтрокиВыписки); 		
		НаборЗаписей.Записать();
		
КонецПроцедуры
	
Функция ПолучитьИдентификаторСтроки(ОбъектСсылка, ИмяФорматаОбъекта, НомерСтрокиВыписки) Экспорт 
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ИдентификаторыВыгружаемыхОбъектов.ИдентификаторОбъекта КАК ИдентификаторОбъекта
	|ИЗ
	|	РегистрСведений.ИдентификаторыВыгружаемыхОбъектов КАК ИдентификаторыВыгружаемыхОбъектов
	|ГДЕ
	|	ИдентификаторыВыгружаемыхОбъектов.Объект = &Объект
	|	И ИдентификаторыВыгружаемыхОбъектов.ИмяФорматаОбъекта = &ИмяФорматаОбъекта
	|	И ИдентификаторыВыгружаемыхОбъектов.НомерСтрокиВыписки = &НомерСтрокиВыписки";
	Запрос.УстановитьПараметр("Объект", ОбъектСсылка);
	Запрос.УстановитьПараметр("ИмяФорматаОбъекта", ИмяФорматаОбъекта);
	Запрос.УстановитьПараметр("НомерСтрокиВыписки", НомерСтрокиВыписки);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Если НЕ Выборка.Следующий() Тогда
		
		Возврат "";
	Иначе 
		Возврат Выборка.ИдентификаторОбъекта;
	КонецЕсли;

КонецФункции



#КонецОбласти

#КонецОбласти