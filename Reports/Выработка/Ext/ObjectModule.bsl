#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	ОтборКомпоновки = КомпоновщикНастроек.Настройки.Отбор;
	
	ОтчетыПлатформаСервер.ВывестиОтчет(ЭтотОбъект, ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка);
	
	ЕстьОтборПоНоменклатуре = (ОтчетыПлатформаСервер.КомпоновщикСчетчикУсловийПоля(Новый ПолеКомпоновкиДанных("Номенклатура"), ОтборКомпоновки)>0);
	ЕстьОтборПоРаботе       = (ОтчетыПлатформаСервер.КомпоновщикСчетчикУсловийПоля(Новый ПолеКомпоновкиДанных("Авторабота"),   ОтборКомпоновки)>0);
	
	Если ЕстьОтборПоНоменклатуре И ЕстьОтборПоРаботе Тогда
		
		МакетПодвалаОтчета = ПолучитьМакет("МакетПодвала");
		ОбластьПодвала = МакетПодвалаОтчета.ПолучитьОбласть("Подвал");
		ОбластьПодвала.Параметры.ОстатокНаНачалоПериода           = "Остаток автомобилей на начало периода: "       + Формат(0,"ЧЦ=15; ЧДЦ=0; ЧН=0");
		ОбластьПодвала.Параметры.ПриходАвтомобилейЗаПериод        = "Приход автомобилей на ремонт: "               + Формат(0,"ЧЦ=15; ЧДЦ=0; ЧН=0");
		ОбластьПодвала.Параметры.ОтработаноАвтомобилей            = "Отработано машино-заездов: "                      + Формат(0,"ЧЦ=15; ЧДЦ=0; ЧН=0");
		ОбластьПодвала.Параметры.ОстатокАвтомобилейНаКонецПериода = "Остаток автомобилей на конец периода: " + Формат(0,"ЧЦ=15; ЧДЦ=0; ЧН=0");
		ДокументРезультат.Вывести(ОбластьПодвала);
		Возврат;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	ДатаНач = ОтчетыПлатформаСервер.КомпоновщикПолучитьЗначениеПараметра("НачалоПериода", КомпоновщикНастроек.Настройки);
	ДатаКон = ОтчетыПлатформаСервер.КомпоновщикПолучитьЗначениеПараметра("КонецПериода",  КомпоновщикНастроек.Настройки);
	Запрос.УстановитьПараметр("ДатаНач",    ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон",    ДатаКон);
	Запрос.УстановитьПараметр("ПустаяДата", Дата(1, 1, 1));
	
	//ТекстСоединенийСвойств = "";
	//ТекстВыборкиСвойств = "";
	//ТекстСоединенийСвойствНоменклатуры = "";
	//ТекстВыборкиСвойствНоменклатуры = "";
	//// Получаем свойства, которые используются в отборе отчета
	//Для Каждого ТекОтбор Из ПостроительОтчета.Отбор Цикл
	//	Если НЕ ТекОтбор.Использование Тогда
	//		Продолжить;
	//	КонецЕсли;
	//	ИдентификаторПути = СтрЗаменить(ТекОтбор.ПутьКДанным, ".", "");
	//	Если СтруктураСвязиСвойств.Свойство(ИдентификаторПути) Тогда
	//		ИмяСвойства = СтрЗаменить(ИдентификаторПути, "Значение", "");
	//		ЗначениеСвойства = СтруктураСвязиСвойств[ИдентификаторПути];
	//		
	//		НаименованиеСвойства = ЗначениеСвойства.Представление;
	//		ИмяПараметра = ЗначениеСвойства.ИмяПараметра;
	//		ПутьКДаннымПоля = "ТаблицаЗаказов." + ЗначениеСвойства.ИмяИзмерения;
	//		
	//		ЗапросСвойстваПоля = ",ВЫБОР КОГДА " + ИмяСвойства + ".Значение ЕСТЬ NULL ТОГДА """ + НаименованиеСвойства + ": <Пусто>"" ИНАЧЕ " + ИмяСвойства + ".Значение КОНЕЦ КАК " + ИдентификаторПути + "	//СВОЙСТВО" + Символы.ПС;
	//		ЗапросСвойстваСоединение = "{ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК " + ИмяСвойства + " ПО " + ИмяСвойства + ".Объект = " + ПутьКДаннымПоля + " И " + ИмяСвойства + ".Свойство = &" + ИмяПараметра + "}	//СВОЙСТВО" + Символы.ПС;
	//		
	//		Если ЗначениеСвойства.ИмяИзмерения = "Номенклатура" Тогда
	//			ЕстьОтборПоНоменклатуре = Истина;
	//			ТекстВыборкиСвойствНоменклатуры		= ТекстВыборкиСвойствНоменклатуры      + ЗапросСвойстваПоля;
	//			ТекстСоединенийСвойствНоменклатуры	= ТекстСоединенийСвойствНоменклатуры   + ЗапросСвойстваСоединение;
	//		ИначеЕсли ЗначениеСвойства.ИмяИзмерения = "Работа" Тогда
	//			ЕстьОтборПоНоменклатуре = Истина;
	//			ТекстВыборкиСвойствНоменклатуры		= ТекстВыборкиСвойствНоменклатуры      + ЗапросСвойстваПоля;
	//			ТекстСоединенийСвойствНоменклатуры	= ТекстСоединенийСвойствНоменклатуры   + ЗапросСвойстваСоединение;
	//		Иначе
	//			ТекстВыборкиСвойств		= ТекстВыборкиСвойств      + ЗапросСвойстваПоля;
	//			ТекстСоединенийСвойств	= ТекстСоединенийСвойств   + ЗапросСвойстваСоединение;
	//		КонецЕсли;
	//		ПостроительИтогов.Параметры.Вставить(ЗначениеСвойства.ИмяПараметра, ЗначениеСвойства.Свойство);
	//	КонецЕсли;
	//	
	//	Если Найти(ТекОтбор.ПутьКДанным, "Номенклатура") = 1 Тогда
	//		ЕстьОтборПоНоменклатуре = Истина;
	//	ИначеЕсли Найти(ТекОтбор.ПутьКДанным, "Работа") = 1 Тогда
	//		ЕстьОтборПоНоменклатуре = Истина;
	//	КонецЕсли;
	//КонецЦикла;
	// получаем данные из базы.
	
	Если ЕстьОтборПоНоменклатуре Тогда
		
		СоответствиеЗамен = Новый Соответствие;
		СоответствиеЗамен.Вставить("Организация",           "Ссылка.Организация");
		СоответствиеЗамен.Вставить("ПодразделениеКомпании", "Ссылка.ПодразделениеКомпании");
		СоответствиеЗамен.Вставить("ВидРемонта",            "Ссылка.ВидРемонта");
		СоответствиеЗамен.Вставить("ЦехЗаказа",             "Ссылка.Цех");
		СоответствиеЗамен.Вставить("ЗаказНаряд",            "Ссылка");
		
		ПоляОграничения = Новый Массив;
		ПоляОграничения.Добавить("Организация");
		ПоляОграничения.Добавить("ПодразделениеКомпании");
		ПоляОграничения.Добавить("ВидРемонта");
		ПоляОграничения.Добавить("ЦехЗаказа");
		ПоляОграничения.Добавить("ЗаказНаряд");
		ПоляОграничения.Добавить("Номенклатура");
		
		ТекстОтбора = ОтчетыПлатформаСервер.КомпоновщикПолучитьТекстОтбора(ОтборКомпоновки.Элементы, ОтборКомпоновки.ДоступныеПоляОтбора, "ДокументЗаказНаряд", Запрос.Параметры, СоответствиеЗамен, ПоляОграничения);
		ТекстОтбора = ?(ТекстОтбора = "", "", " И "+Символы.ПС) + ТекстОтбора;
		
		ТекстЗапросаИтоговый = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДокументЗаказНаряд.Ссылка КАК ЗаказНаряд,
		|	ДокументЗаказНаряд.Ссылка.ДатаЗакрытия КАК ДатаЗакрытия,
		|	ДокументЗаказНаряд.Ссылка.ДатаОкончания КАК ДатаОкончания,
		|	ДокументЗаказНаряд.Ссылка.ДатаСоздания КАК ДатаСоздания
		|ПОМЕСТИТЬ
		|	ТаблицаЗаказНарядов
		|ИЗ
		|	Документ.ЗаказНаряд.Товары КАК ДокументЗаказНаряд
		|ГДЕ
		|	ДокументЗаказНаряд.Ссылка.ПометкаУдаления = ЛОЖЬ И 
		|	((ДокументЗаказНаряд.Ссылка.ДатаСоздания < &ДатаНач И
		|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.Ссылка.ДатаОкончания >= &ДатаНач ИЛИ ДокументЗаказНаряд.Ссылка.ДатаЗакрытия >= &ДатаНач)) ИЛИ
		|		 (ДокументЗаказНаряд.Ссылка.ДатаСоздания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ
		|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ
		|		 (ДокументЗаказНаряд.Ссылка.ДатаЗакрытия МЕЖДУ &ДатаНач И &ДатаКон))" + ТекстОтбора;
		//|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ
		//|		 (ДокументЗаказНаряд.Ссылка.ДатаСоздания <= &ДатаКон И 
		//|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.Ссылка.ДатаОкончания > &ДатаКон ИЛИ ДокументЗаказНаряд.Ссылка.ДатаЗакрытия > &ДатаКон)))" + ТекстОтбора;
		
	ИначеЕсли ЕстьОтборПоРаботе Тогда
		
		СоответствиеЗамен = Новый Соответствие;
		СоответствиеЗамен.Вставить("Организация",           "Ссылка.Организация");
		СоответствиеЗамен.Вставить("ПодразделениеКомпании", "Ссылка.ПодразделениеКомпании");
		СоответствиеЗамен.Вставить("ВидРемонта",            "Ссылка.ВидРемонта");
		СоответствиеЗамен.Вставить("ЦехЗаказа",             "Ссылка.Цех");
		СоответствиеЗамен.Вставить("ЗаказНаряд",            "Ссылка");
		
		ПоляОграничения = Новый Массив;
		ПоляОграничения.Добавить("Организация");
		ПоляОграничения.Добавить("ПодразделениеКомпании");
		ПоляОграничения.Добавить("ВидРемонта");
		ПоляОграничения.Добавить("ЦехЗаказа");
		ПоляОграничения.Добавить("ЗаказНаряд");
		ПоляОграничения.Добавить("Авторабота");
		
		ТекстОтбора = ОтчетыПлатформаСервер.КомпоновщикПолучитьТекстОтбора(ОтборКомпоновки.Элементы, ОтборКомпоновки.ДоступныеПоляОтбора, "ДокументЗаказНаряд", Запрос.Параметры, СоответствиеЗамен, ПоляОграничения);
		ТекстОтбора = ?(ТекстОтбора = "", "", " И "+Символы.ПС) + ТекстОтбора;
		
		ТекстЗапросаИтоговый = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДокументЗаказНаряд.Ссылка КАК ЗаказНаряд,
		|	ДокументЗаказНаряд.Ссылка.ДатаЗакрытия КАК ДатаЗакрытия,
		|	ДокументЗаказНаряд.Ссылка.ДатаОкончания КАК ДатаОкончания,
		|	ДокументЗаказНаряд.Ссылка.ДатаСоздания КАК ДатаСоздания
		|ПОМЕСТИТЬ
		|	ТаблицаЗаказНарядов
		|ИЗ
		|	Документ.ЗаказНаряд.Автоработы КАК ДокументЗаказНаряд
		|ГДЕ
		|	ДокументЗаказНаряд.Ссылка.ПометкаУдаления = ЛОЖЬ И 
		|	((ДокументЗаказНаряд.Ссылка.ДатаСоздания < &ДатаНач И 
		|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.Ссылка.ДатаОкончания >= &ДатаНач ИЛИ ДокументЗаказНаряд.Ссылка.ДатаЗакрытия >= &ДатаНач)) ИЛИ 
		|		 (ДокументЗаказНаряд.Ссылка.ДатаСоздания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ 
		|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ 
		|		 (ДокументЗаказНаряд.Ссылка.ДатаЗакрытия МЕЖДУ &ДатаНач И &ДатаКон))" + ТекстОтбора;
		//|		 (ДокументЗаказНаряд.Ссылка.ДатаСоздания <= &ДатаКон И 
		//|		 (ДокументЗаказНаряд.Ссылка.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.Ссылка.ДатаОкончания > &ДатаКон)))" + ТекстОтбора;
		
	Иначе
		
		СоответствиеЗамен = Новый Соответствие;
		СоответствиеЗамен.Вставить("ЗаказНаряд", "Ссылка");
		СоответствиеЗамен.Вставить("ЦехЗаказа", "Цех");
		
		ПоляОграничения = Новый Массив;
		ПоляОграничения.Добавить("Организация");
		ПоляОграничения.Добавить("ПодразделениеКомпании");
		ПоляОграничения.Добавить("ВидРемонта");
		ПоляОграничения.Добавить("ЦехЗаказа");
		ПоляОграничения.Добавить("ЗаказНаряд");
		ТекстОтбора = ОтчетыПлатформаСервер.КомпоновщикПолучитьТекстОтбора(ОтборКомпоновки.Элементы, ОтборКомпоновки.ДоступныеПоляОтбора, "ДокументЗаказНаряд", Запрос.Параметры, СоответствиеЗамен, ПоляОграничения);
		
		ТекстОтбора = ?(ТекстОтбора = "", "", " И "+Символы.ПС) + ТекстОтбора;

		ТекстЗапросаИтоговый =  "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДокументЗаказНаряд.Ссылка КАК ЗаказНаряд,
		|	ДокументЗаказНаряд.ДатаЗакрытия КАК ДатаЗакрытия,
		|	ДокументЗаказНаряд.ДатаОкончания КАК ДатаОкончания,
		|	ДокументЗаказНаряд.ДатаСоздания КАК ДатаСоздания
		|ПОМЕСТИТЬ
		|	ТаблицаЗаказНарядов
		|ИЗ
		|	Документ.ЗаказНаряд КАК ДокументЗаказНаряд
		|ГДЕ
		|	ДокументЗаказНаряд.ПометкаУдаления = ЛОЖЬ И 
		|	((ДокументЗаказНаряд.ДатаСоздания < &ДатаНач И 
		|	 (ДокументЗаказНаряд.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.ДатаОкончания >= &ДатаНач ИЛИ ДокументЗаказНаряд.ДатаЗакрытия >= &ДатаНач)) ИЛИ
		|	 (ДокументЗаказНаряд.ДатаСоздания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ
		|	 (ДокументЗаказНаряд.ДатаОкончания МЕЖДУ &ДатаНач И &ДатаКон) ИЛИ
		|	 (ДокументЗаказНаряд.ДатаЗакрытия МЕЖДУ &ДатаНач И &ДатаКон))" + ТекстОтбора;
		//|	 (ДокументЗаказНаряд.ДатаСоздания <= &ДатаКон И (ДокументЗаказНаряд.ДатаОкончания = &ПустаяДата ИЛИ ДокументЗаказНаряд.ДатаОкончания > &ДатаКон)))" + ТекстОтбора;
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапросаИтоговый + "
	|;
	|
	|ВЫБРАТЬ
	|	СУММА(ИтоговаяТаблица.ОстатокАвтомобилейНаНачалоПериода) КАК ОстатокАвтомобилейНаНачалоПериода,
	|	СУММА(ИтоговаяТаблица.КоличествоАвтомобилейПоступившихЗаПериод) КАК КоличествоАвтомобилейПоступившихЗаПериод,
	|	СУММА(ИтоговаяТаблица.КоличествоАвтомобилейОтработанныхЗаПериод) КАК КоличествоАвтомобилейОтработанныхЗаПериод,
	|	СУММА(ИтоговаяТаблица.ОстатокАвтомобилейНаКонецПериода) КАК ОстатокАвтомобилейНаКонецПериода
	|ИЗ
	|	(ВЫБРАТЬ
	|		КОЛИЧЕСТВО(ТаблицаЗаказНарядов.ЗаказНаряд) КАК ОстатокАвтомобилейНаНачалоПериода,
	|		0 КАК КоличествоАвтомобилейПоступившихЗаПериод,
	|		0 КАК КоличествоАвтомобилейОтработанныхЗаПериод,
	|		0 КАК ОстатокАвтомобилейНаКонецПериода
	|	ИЗ
	|		ТаблицаЗаказНарядов КАК ТаблицаЗаказНарядов
	|	ГДЕ
	|		ТаблицаЗаказНарядов.ДатаСоздания < &ДатаНач И 
	|		(ТаблицаЗаказНарядов.ДатаОкончания = &ПустаяДата ИЛИ ТаблицаЗаказНарядов.ДатаОкончания >= &ДатаНач ИЛИ ТаблицаЗаказНарядов.ДатаЗакрытия >= &ДатаНач)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		0,
	|		КОЛИЧЕСТВО(ТаблицаЗаказНарядов.ЗаказНаряд),
	|		0,
	|		0
	|	ИЗ
	|		ТаблицаЗаказНарядов КАК ТаблицаЗаказНарядов
	|	ГДЕ
	|		ТаблицаЗаказНарядов.ДатаСоздания МЕЖДУ &ДатаНач И &ДатаКон
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		0,
	|		0,
	|		КОЛИЧЕСТВО(ТаблицаЗаказНарядов.ЗаказНаряд),
	|		0
	|	ИЗ
	|		ТаблицаЗаказНарядов КАК ТаблицаЗаказНарядов
	|	ГДЕ
	|		ТаблицаЗаказНарядов.ДатаОкончания МЕЖДУ &ДатаНач И &ДатаКон ИЛИ ТаблицаЗаказНарядов.ДатаЗакрытия МЕЖДУ &ДатаНач И &ДатаКон 
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		0,
	|		0,
	|		0,
	|		КОЛИЧЕСТВО(ТаблицаЗаказНарядов.ЗаказНаряд)
	|	ИЗ
	|		ТаблицаЗаказНарядов КАК ТаблицаЗаказНарядов
	|	ГДЕ
	|		ТаблицаЗаказНарядов.ДатаСоздания <= &ДатаКон И 
	|		(ТаблицаЗаказНарядов.ДатаОкончания = &ПустаяДата ИЛИ ТаблицаЗаказНарядов.ДатаОкончания > &ДатаКон ИЛИ ТаблицаЗаказНарядов.ДатаЗакрытия > &ДатаКон)) КАК ИтоговаяТаблица";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ОстатокАвтомобилейНаНачалоПериода = 0;
	КоличествоАвтомобилейПоступившихЗаПериод = 0;
	КоличествоАвтомобилейОтработанныхЗаПериод = 0;
	ОстатокАвтомобилейНаКонецПериода = 0;
	Если Выборка.Следующий() Тогда
		ОстатокАвтомобилейНаНачалоПериода = Выборка.ОстатокАвтомобилейНаНачалоПериода;
		КоличествоАвтомобилейПоступившихЗаПериод = Выборка.КоличествоАвтомобилейПоступившихЗаПериод;
		КоличествоАвтомобилейОтработанныхЗаПериод = Выборка.КоличествоАвтомобилейОтработанныхЗаПериод;
		ОстатокАвтомобилейНаКонецПериода = Выборка.ОстатокАвтомобилейНаКонецПериода;
	КонецЕсли;
	
	МакетПодвалаОтчета = ПолучитьМакет("МакетПодвала");
	ОбластьПодвала = МакетПодвалаОтчета.ПолучитьОбласть("Подвал");
	ОбластьПодвала.Параметры.ОстатокНаНачалоПериода           = "Остаток автомобилей на начало периода: " + Формат(ОстатокАвтомобилейНаНачалоПериода, "ЧЦ=15; ЧДЦ=0; ЧН=0");
	ОбластьПодвала.Параметры.ПриходАвтомобилейЗаПериод        = "Приход автомобилей на ремонт: "          + Формат(КоличествоАвтомобилейПоступившихЗаПериод,  "ЧЦ=15; ЧДЦ=0; ЧН=0");
	ОбластьПодвала.Параметры.ОтработаноАвтомобилей            = "Отработано машино-заездов: "             + Формат(КоличествоАвтомобилейОтработанныхЗаПериод, "ЧЦ=15; ЧДЦ=0; ЧН=0");
	ОбластьПодвала.Параметры.ОстатокАвтомобилейНаКонецПериода = "Остаток автомобилей на конец периода: "  + Формат(ОстатокАвтомобилейНаКонецПериода,  "ЧЦ=15; ЧДЦ=0; ЧН=0");
	ДокументРезультат.Вывести(ОбластьПодвала);
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли