// Модуль набора записей регистра накоплений "Доходы и расходы"

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОписаниеПеременных

Перем ДокументОбъект Экспорт; // документ объект
Перем СтатьяДоходовИРасходов Экспорт; // Статья ДДС
Перем Подразделение Экспорт; // если неопределено, то берется из ДокументОбъект
Перем ВУпрВалюте Экспорт; // если Истина, то суммы переданы в валюте упр. учета и пересчитывать их не надо
Перем Доход Экспорт; // доход
Перем Расход Экспорт; // расход
Перем ШапкаДокумента Экспорт; 			// Выборка или строка таблицы значений, в которой содержаться необходимые данные о шапке документа
Перем РежимПроведения Экспорт;		// Режим проведения документа оперативный/неоперативный
Перем ХозОперация Экспорт; // Хозяйственная операция. Если пустое, то берется из документа.
Перем СтатьяДиРИсточник Экспорт; // Статья доходов и расходов, с которой произошло распределение.
								 // Используется в документе "Закрытие периода".

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Фиксируем доходы/расходы
Функция Приход() Экспорт
	Если ШапкаДокумента=Неопределено Тогда
		ШапкаДокумента=ДокументОбъект;
	КонецЕсли;
	Доход=?(Доход=Неопределено ИЛИ Доход=NULL,0,Доход);
	Расход=?(Расход=Неопределено ИЛИ Расход=NULL,0,Расход);
	// Проверим
	Если Доход=0 И Расход=0 Тогда 
		// Убиваем циклическую ссылку
		ДокументОбъект=Неопределено;
		ШапкаДокумента=Неопределено;
		Возврат Истина; 
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Подразделение) Тогда
		Подразделение = ШапкаДокумента.ПодразделениеКомпании;
	КонецЕсли;
	
	ВУпрВалюте=?(ВУпрВалюте=Неопределено,Ложь,ВУпрВалюте);
	ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	// Движения
	НоваяЗапись=Добавить();
	НоваяЗапись.ВидДвижения=ВидДвиженияНакопления.Приход;
	НоваяЗапись.Период=ШапкаДокумента.Дата;
	НоваяЗапись.Регистратор=ШапкаДокумента.Ссылка;
	НоваяЗапись.ПодразделениеКомпании=Подразделение;
	НоваяЗапись.СтатьяДоходовИРасходов=СтатьяДоходовИРасходов;
	Если ВУпрВалюте Тогда
		НоваяЗапись.ДоходУпр=Окр(Доход,2);
		НоваяЗапись.РасходУпр=Окр(Расход,2);
	Иначе
		НоваяЗапись.ДоходУпр=Окр(РаботаСКурсамиВалютПлатформа.ПересчетПоВалюте(Доход,ШапкаДокумента.ВалютаДокумента,ШапкаДокумента.КурсДокумента,ВалютаУпр,?(НЕ ЗначениеЗаполнено(ШапкаДокумента.КурсВалютыУпр), ШапкаДокумента.Дата, ШапкаДокумента.КурсВалютыУпр)),2);
		НоваяЗапись.РасходУпр=Окр(РаботаСКурсамиВалютПлатформа.ПересчетПоВалюте(Расход,ШапкаДокумента.ВалютаДокумента,ШапкаДокумента.КурсДокумента,ВалютаУпр,?(НЕ ЗначениеЗаполнено(ШапкаДокумента.КурсВалютыУпр), ШапкаДокумента.Дата, ШапкаДокумента.КурсВалютыУпр)),2);
	КонецЕсли;
	// Хоз. операция
	Если ХозОперация=Неопределено Тогда
		ХозОперация = ШапкаДокумента.ХозОперация;
	КонецЕсли;  	
	НоваяЗапись.ХозОперация = ХозОперация;
	
	// Распределяемая статья.
	Если СтатьяДиРИсточник<>Неопределено Тогда
		НоваяЗапись.СтатьяРаспределения = СтатьяДиРИсточник;			
	КонецЕсли;   	
	
	// Обнуляем переменные
	Подразделение = Неопределено;
	Доход=0; Расход=0; ВУпрВалюте=Ложь;
	
	// Убиваем циклическую ссылку
	ДокументОбъект=Неопределено;
	ШапкаДокумента=Неопределено;
	
	Возврат Истина;
КонецФункции

// фиксируем доходы/расходы
Функция Расход() Экспорт
	Если ШапкаДокумента=Неопределено Тогда ШапкаДокумента=ДокументОбъект; КонецЕсли;
	Доход=?(Доход=Неопределено ИЛИ Доход=NULL,0,Доход);
	Расход=?(Расход=Неопределено ИЛИ Расход=NULL,0,Расход);
	// проверим
	Если Доход=0 И Расход=0 Тогда 
		// убиваем циклическую ссылку
		ДокументОбъект=Неопределено;
		ШапкаДокумента=Неопределено;
		Возврат Истина; 
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Подразделение) Тогда
		Подразделение = ШапкаДокумента.ПодразделениеКомпании;
	КонецЕсли;
	
	ВУпрВалюте=?(ВУпрВалюте=Неопределено,Ложь,ВУпрВалюте);
	ВалютаУпр=Константы.ВалютаУправленческогоУчетаКомпании.Получить();
	// движения
	НоваяЗапись=Добавить();
	НоваяЗапись.ВидДвижения=ВидДвиженияНакопления.Расход;
	НоваяЗапись.Период=ШапкаДокумента.Дата;
	НоваяЗапись.Регистратор=ШапкаДокумента.Ссылка;
	НоваяЗапись.ПодразделениеКомпании=Подразделение;
	НоваяЗапись.СтатьяДоходовИРасходов=СтатьяДоходовИРасходов;
	Если ВУпрВалюте Тогда
		НоваяЗапись.ДоходУпр=Окр(Доход,2);
		НоваяЗапись.РасходУпр=Окр(Расход,2);
	Иначе
		НоваяЗапись.ДоходУпр=Окр(РаботаСКурсамиВалютПлатформа.ПересчетПоВалюте(Доход,ШапкаДокумента.ВалютаДокумента,ШапкаДокумента.КурсДокумента,ВалютаУпр,?(НЕ ЗначениеЗаполнено(ШапкаДокумента.КурсВалютыУпр), ШапкаДокумента.Дата, ШапкаДокумента.КурсВалютыУпр)),2);
		НоваяЗапись.РасходУпр=Окр(РаботаСКурсамиВалютПлатформа.ПересчетПоВалюте(Расход,ШапкаДокумента.ВалютаДокумента,ШапкаДокумента.КурсДокумента,ВалютаУпр,?(НЕ ЗначениеЗаполнено(ШапкаДокумента.КурсВалютыУпр), ШапкаДокумента.Дата, ШапкаДокумента.КурсВалютыУпр)),2);
	КонецЕсли;
	// Хоз. операция
	Если ХозОперация=Неопределено Тогда
		ХозОперация = ШапкаДокумента.ХозОперация;
	КонецЕсли;  	
	НоваяЗапись.ХозОперация = ХозОперация;
		
	// обнуляем переменные
	Подразделение = Неопределено;
	Доход=0; Расход=0; ВУпрВалюте=Ложь;
	
	// убиваем циклическую ссылку
	ДокументОбъект=Неопределено;
	ШапкаДокумента=Неопределено;
	
	Возврат Истина;
КонецФункции

#КонецОбласти

#КонецЕсли